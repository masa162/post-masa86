# 要件定義書 - post-masa86

## プロジェクト概要

**目的**: masa86.comのリニューアル - ミニマルなテキストベース雑記ブログ  
**URL**: https://blog.masa86.com  
**期間**: 長期運用（30年目標）  
**思想**: ミニマル、長期安定、堅牢、static、軽量高速、スケーラブル

## 技術スタック

### フロントエンド・バックエンド
- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **スタイリング**: TailwindCSS + Custom CSS

### インフラ（Cloudflare）
- **ホスティング**: Cloudflare Pages
- **データベース**: Cloudflare D1 (SQLite)
- **ランタイム**: Cloudflare Workers (Edge Runtime)
- **アカウント**: Belong2jazz@gmail.com

### 重要な実装方針（失敗からの学び）

1. **wrangler.tomlは使用しない**
   - 全ての設定はCloudflare Dashboardで行う
   - compatibility_flagsなどの設定がコードで上書きされる問題を回避

2. **D1アクセス方法**
   - `process.env.DB`を使用（clasicjlitプロジェクトと同じ）
   - グローバル型定義で`ProcessEnv.DB`を定義
   - ビルド時用のモックD1を用意

3. **全ルートに必須設定**
   ```typescript
   export const dynamic = 'force-dynamic'
   export const revalidate = 0
   export const runtime = 'edge'
   ```

## 機能要件

### 公開サイト（blog.masa86.com）

#### 1. トップページ
- 最新5件の記事を表示
- カード型レイアウト
- サイドバー（検索、About、タグ一覧）

#### 2. 記事詳細ページ
- URL: `blog.masa86.com/{slug}`
- Markdownレンダリング
- タグ表示
- 日付表示

#### 3. タグページ
- URL: `blog.masa86.com/tags/{tag}`
- タグ別の記事一覧

#### 4. 検索ページ
- URL: `blog.masa86.com/search?q={keyword}`
- タイトル・本文のフルテキスト検索

#### 5. SEO対応
- サイトマップ自動生成（`/sitemap.xml`）
- robots.txt

### 管理画面（blog.masa86.com/admin）

#### 認証
- Basic認証
- ID: `mn`
- Password: `39`

#### 機能
1. **記事一覧** (`/admin`)
   - 作成日降順
   - 20件/ページ
   - Slug、タイトル、タグ、日付を表示

2. **新規作成** (`/admin/new`)
   - タイトル入力
   - 本文入力（Markdownテキストエリア）
   - タグ選択（事前定義から選択）
   - 保存時に自動連番slug割り当て（0050, 0051...）

3. **編集** (`/admin/edit/{id}`)
   - 既存記事の編集
   - タイトル、本文、タグの変更

4. **削除**
   - 確認ダイアログ付き
   - 物理削除（完全削除）

## データ仕様

### データベース（D1）

#### postsテーブル
```sql
CREATE TABLE posts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  slug TEXT UNIQUE NOT NULL,        -- "0001", "0002", ...
  title TEXT NOT NULL,
  content TEXT NOT NULL,             -- Markdown本文
  tags TEXT,                         -- JSON配列形式
  created_at TEXT NOT NULL,          -- ISO8601形式
  updated_at TEXT NOT NULL
);
```

#### インデックス
```sql
CREATE INDEX idx_posts_created_at ON posts(created_at DESC);
CREATE INDEX idx_posts_slug ON posts(slug);
```

### 記事ID/Slug
- **形式**: 4桁ゼロ埋め連番
- **範囲**: 0001 ～ 9999
- **自動採番**: 最新の記事番号 + 1
- **総数**: 約10年分（365件/年として）

### タグ
- **管理方式**: 事前定義
- **保存形式**: JSON配列（例：`["日常", "読書"]`）
- **事前定義タグ**: 日常、読書、技術、映画、音楽、旅行、食べ物、考察

## デザイン要件

### デザインソース
- **参考サイト**: https://masa86.com/ (既存Hugoサイト)
- **コンセプト**: ミニマル、テキストのみ、シンプル

### カラーパレット
```
テキスト: #333333
リンク: #0066cc
リンクホバー: #004499
ボーダー: #e0e0e0
背景: #ffffff
タグ背景: #f0f0f0
ミュート: #666666
```

### レイアウト
- **コンテナ最大幅**: 860px
- **メインコンテンツ**: 620px
- **サイドバー**: 240px
- **モバイル**: 1カラム、サイドバー非表示

### タイポグラフィ
- **フォント**: Helvetica Neue, Arial, sans-serif
- **本文**: 16px / line-height 1.6
- **見出し**: シンプル、ボーダー付き
- **記事内h1**: #2d4a3a、下線3px
- **記事内h2**: #2d4a3a、下線2px

### レスポンシブ対応
- **デスクトップ**: 2カラムレイアウト
- **タブレット**: 1カラム
- **モバイル**: 1カラム、タッチ対応（最小タップ領域44px）

## マイグレーション要件

### 既存データ
- **ソース**: D:\github\masa86\content\posts
- **形式**: Hugo Markdown（Front Matter + 本文）
- **件数**: 49件
- **日付範囲**: 2023年10月 ～ 2025年10月

### マイグレーション処理
1. Front Matter（title, date, tags）を抽出
2. Markdown本文を抽出
3. 日付順にソート（古い順）
4. 連番slug割り当て（0001～0049）
5. D1にINSERT

## 非機能要件

### パフォーマンス
- **目標PV**: 10,000/月
- **Cloudflare Pages無料枠**: 500リクエスト/秒（十分）
- **D1無料枠**: 50,000 reads/day（十分）

### セキュリティ
- 管理画面はBasic認証で保護
- 公開APIなし（全て認証必須）
- XSS対策（Markdownサニタイズ）

### 可用性
- Cloudflare Edgeで高可用性
- D1の自動バックアップ
- Git管理でコード復旧可能

## 運用要件

### 記事執筆ワークフロー
1. 管理画面にアクセス
2. 「新規作成」ボタンをクリック
3. タイトル入力
4. タグ選択（複数選択可能）
5. 本文入力（Markdown）
6. 「保存」ボタンでD1に保存
7. 自動的に次の連番slugが割り当てられる

**重要**: 記事IDやslugを意識する必要なし

### スマホ対応
- スマホから記事作成・編集可能
- シンプルなテキストエリアのみ（プレビュー不要）
- タッチ操作に最適化

## 除外要件（不要な機能）

- ❌ 下書き機能
- ❌ 編集履歴
- ❌ RSS Feed
- ❌ コメント機能
- ❌ アイキャッチ画像
- ❌ カテゴリ機能
- ❌ 一括操作
- ❌ プレビュー機能

## 技術的制約

### Cloudflare Pages
- **nodejs_compat フラグ**: Dashboard設定で有効化（必須）
- **D1バインディング**: Dashboard設定（変数名: DB）
- **環境変数**: Dashboard設定（wrangler.tomlは使用しない）

### Next.js
- **ビルド**: `next build`
- **Cloudflareビルド**: `npx @cloudflare/next-on-pages`
- **出力**: `.vercel/output/static`
- **Dynamic rendering**: 全ルートで`force-dynamic`を使用

### D1制限
- **最大DB サイズ**: 10GB
- **最大行数**: 25億行
- **テキスト記事なら数万件対応可能**

## 成功基準

### 必須
1. ✅ トップページが表示される
2. ✅ 49件の記事が全て表示される
3. ✅ 記事詳細ページが開ける
4. ✅ 管理画面でログインできる
5. ✅ 新規記事が作成できる
6. ✅ スマホで正常に表示される

### 望ましい
- タグページが動作する
- 検索機能が動作する
- サイトマップが生成される

## リスク・課題

### 前回の失敗要因
1. **wrangler.tomlの設定がDashboard設定を上書き**
   - 対策: wrangler.tomlを使用しない

2. **D1へのアクセス方法が不適切**
   - 対策: `process.env.DB`を使用（clasicjlit方式）

3. **ビルド時にD1にアクセスしようとする**
   - 対策: `dynamic = 'force-dynamic'`を全ルートに設定

### 今回の対策
- 実証済みのclasicjlitプロジェクトを完全に参考にする
- 最小構成から始める（段階的に機能追加）
- 各ステップで動作確認

## 参考プロジェクト

### clasicjlit（成功例）
- **パス**: D:\github\clasicjlit
- **同じ構成**: Next.js 15 + Cloudflare Pages + D1
- **稼働中**: https://clasicjlit.pages.dev/
- **参考にする実装**:
  - `src/lib/d1.ts` - D1アクセス方法
  - `src/types/cloudflare.ts` - 型定義
  - `next.config.ts` - Next.js設定
  - APIルートの実装パターン

### masa86（既存Hugo）
- **パス**: D:\github\masa86
- **デザインソース**: https://masa86.com/
- **マイグレーション元**: 49件の記事
- **参考CSS**: `static/css/custom.css`

## 開発フェーズ

### Phase 1: 最小構成（Hello World）
1. Next.js 15プロジェクト作成
2. D1データベース作成・接続
3. トップページ表示（記事なしでOK）
4. Cloudflare Pagesデプロイ成功

### Phase 2: 記事表示
1. D1にテスト記事1件を追加
2. トップページで1件表示
3. 記事詳細ページ表示

### Phase 3: データ移行
1. Hugoマイグレーションスクリプト
2. 49件の記事をD1にインポート
3. 全記事の表示確認

### Phase 4: 管理画面
1. Basic認証実装
2. 記事一覧表示
3. 新規作成機能
4. 編集・削除機能

### Phase 5: 付加機能
1. タグ機能
2. 検索機能
3. サイトマップ

### Phase 6: デザイン最適化
1. masa86.comのCSS完全再現
2. レスポンシブ対応
3. モバイル最適化

## デプロイ手順

### D1データベース
```bash
# 作成
npx wrangler d1 create post-masa86-db

# database_idをメモ
```

### Cloudflare Pages
1. Dashboard → Workers & Pages → Create application
2. **Connect to Git**: masa162/post-masa86
3. **Build settings**:
   - Build command: `npx @cloudflare/next-on-pages`
   - Build output: `.vercel/output/static`
   - Root directory: (空欄)

4. **Bindings** (Dashboardで設定):
   - D1 database: `DB = post-masa86-db`

5. **Runtime** (Dashboardで設定):
   - Compatibility flags: `nodejs_compat`

6. **Environment variables** (Dashboardで設定):
   - `BASIC_AUTH_USER = mn`
   - `BASIC_AUTH_PASS = 39`

### 初回デプロイ
```bash
git add .
git commit -m "Initial commit"
git push origin main
```

## 品質保証

### テスト項目
- [ ] トップページが200で応答
- [ ] 記事詳細ページが開ける
- [ ] 管理画面にログインできる
- [ ] 新規記事が作成できる
- [ ] スマホで表示できる
- [ ] タグページが動作する
- [ ] 検索が動作する

### パフォーマンス目標
- 初回表示: < 1秒
- ページ遷移: < 500ms
- 記事作成: < 2秒

## 今後の拡張（将来）

- book.masa86.com（書評サイト）の展開
- カテゴリ機能の追加
- アナリティクス連携

---

**作成日**: 2025-10-30  
**バージョン**: 1.0.0  
**作成者**: masa162

