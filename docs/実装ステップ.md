# 実装ステップ - post-masa86

**目標**: 確実に動作するブログを段階的に構築する

## Phase 1: 最小構成（Hello World）- 最優先

### ✅ チェックリスト

- [x] **Step 1.1**: Next.js 15プロジェクト初期化 ✅ **完了**
  - package.json作成
  - 必要最小限の依存関係のみ
  - wrangler.tomlは作成しない（重要）

- [x] **Step 1.2**: 基本ファイル作成 ✅ **完了**
  - tsconfig.json
  - next.config.js（シンプル版）
  - tailwind.config.ts
  - .gitignore

- [x] **Step 1.3**: 最小限のページ作成 ✅ **完了**
  - app/layout.tsx
  - app/globals.css
  - app/page.tsx（"Hello World"のみ、D1アクセスなし）

- [x] **Step 1.4**: ローカルビルド確認 ✅ **完了**
  - `npm install` → 成功
  - `npm run build` → エラーなし
  - 静的ページとして生成成功

- [x] **Step 1.5**: ローカル動作確認 ✅ **完了**
  - `npm run dev` → 起動成功
  - http://localhost:3000 で "Hello World" 表示確認

- [x] **Step 1.6**: GitHubにプッシュ ✅ **完了**
  - git commit → 15ファイル、12,502行
  - git push origin main → 成功

- [x] **Step 1.7**: Cloudflare Pages初回デプロイ ✅ **完了**
  - Dashboard → Pages → Connect to Git
  - Build command: `npx @cloudflare/next-on-pages`
  - Build output: `.vercel/output/static`
  - デプロイ成功

- [x] **Step 1.8**: 本番URL確認 ✅ **完了**
  - https://post-masa86.pages.dev/
  - "Hello World"が表示される
  - 500エラーが出ない

---

## Phase 2: D1接続テスト ✅ **完了**

### ✅ チェックリスト

- [x] **Step 2.1**: D1データベース作成 ✅
  - `npx wrangler d1 create post-masa86-db`
  - database_id: 007bd3b6-9832-4510-85f6-439743ea7552

- [x] **Step 2.2**: schema.sql作成 ✅
  - postsテーブル定義
  - インデックス定義

- [x] **Step 2.3**: D1テーブル作成 ✅
  - ローカル: `npx wrangler d1 execute --local --file=./schema.sql`
  - 本番: `npx wrangler d1 execute --remote --file=./schema.sql`

- [x] **Step 2.4**: テスト用データ1件追加 ✅
  - test-data.sql作成（1件のみ）
  - D1にインポート

- [x] **Step 2.5**: lib/db.ts作成 ✅
  - getD1()関数（process.env.DB使用）
  - createMockD1()関数
  - getPosts()メソッドのみ実装

- [x] **Step 2.6**: types/cloudflare.ts作成 ✅
  - グローバル型定義

- [x] **Step 2.7**: app/page.tsx更新 ✅
  - dynamic = 'force-dynamic' 追加
  - revalidate = 0 追加
  - runtime = 'edge' 追加
  - db.getPosts()を呼び出し
  - 1件の記事タイトルを表示

- [x] **Step 2.8**: ローカルビルド確認 ✅
  - `npm run build`
  - エラーなし

- [x] **Step 2.9**: GitHubにプッシュ ✅

- [x] **Step 2.10**: Cloudflare Dashboard設定 ✅
  - Bindings → D1 database追加（DB = post-masa86-db）
  - Runtime → Compatibility flags追加（nodejs_compat）

- [x] **Step 2.11**: 再デプロイ実行 ✅
  - Retry deployment

- [x] **Step 2.12**: 本番確認 ✅
  - https://post-masa86.pages.dev/
  - 1件の記事タイトルが表示される
  - 500エラーが出ない

---

## Phase 3: 基本的な記事表示 ✅ **完了**

### ✅ チェックリスト

- [x] **Step 3.1**: components作成 ✅
  - Header.tsx（シンプル）
  - PostCard.tsx（1件表示用）

- [x] **Step 3.2**: lib/markdown.ts作成 ✅
  - parseMarkdown()
  - formatDate()

- [x] **Step 3.3**: app/page.tsx拡張 ✅
  - Header表示
  - PostCard表示

- [x] **Step 3.4**: 記事詳細ページ作成 ✅
  - app/[slug]/page.tsx
  - dynamic/revalidate/runtime設定
  - db.getPostBySlug()実装

- [x] **Step 3.5**: ローカル確認 ✅
  - トップページ表示
  - 記事詳細ページ表示

- [x] **Step 3.6**: GitHubにプッシュ ✅

- [x] **Step 3.7**: 本番確認 ✅
  - トップページOK
  - 記事詳細ページOK

---

## Phase 4: Hugoデータ移行 ✅ **完了**

### ✅ チェックリスト

- [x] **Step 4.1**: scripts/migrate-hugo.ts作成 ✅

- [x] **Step 4.2**: マイグレーション実行 ✅
  - `npm run migrate:hugo`
  - migrate-data.sql生成（49件）

- [x] **Step 4.3**: D1にインポート ✅
  - ローカル: `npx wrangler d1 execute --local --file=./migrate-data.sql`
  - 本番: `npx wrangler d1 execute --remote --file=./migrate-data.sql`

- [x] **Step 4.4**: データ確認 ✅
  - `SELECT COUNT(*) FROM posts`
  - 49件確認

- [x] **Step 4.5**: ローカル確認 ✅
  - トップページで5件表示
  - 記事詳細で全記事アクセス可能

- [x] **Step 4.6**: 本番確認 ✅
  - 49件全て表示される

---

## Phase 5: 管理画面（最小機能） ✅ **完了**

### ✅ チェックリスト

- [x] **Step 5.1**: lib/auth.ts作成 ✅
  - checkBasicAuth()実装
  - 環境変数対応（ハードコード削除）

- [x] **Step 5.2**: app/api/posts/route.ts作成 ✅
  - GET実装（一覧取得）
  - POST実装（新規作成）
  - Basic認証チェック

- [x] **Step 5.3**: app/admin/layout.tsx作成 ✅
  - Basic認証チェック
  - ナビゲーション実装

- [x] **Step 5.4**: app/admin/page.tsx作成 ✅
  - 記事一覧表示（49件）
  - 削除ボタン実装

- [x] **Step 5.5**: ローカル確認 ✅
  - ビルド成功

- [x] **Step 5.6**: GitHubにプッシュ ✅

- [x] **Step 5.7**: 本番確認 ✅
  - /admin が動作する

- [x] **Step 5.8**: app/admin/new/page.tsx作成 ✅
  - 新規作成フォーム実装
  - タグ選択機能

- [x] **Step 5.9**: 記事作成テスト ✅
  - 管理画面で記事作成
  - slug 0050として保存される

- [x] **Step 5.10**: 編集・削除機能追加 ✅
  - app/admin/edit/[id]/page.tsx
  - app/api/posts/[id]/route.ts (PUT/DELETE)

---

## Phase 6: Markdown表示改善 ✅ **完了**

### ✅ チェックリスト

- [x] **Step 6.1**: markedライブラリ追加 ✅
  - proper Markdown parser導入

- [x] **Step 6.2**: 画像表示修正 ✅
  - `![alt](url)` が正しく表示されるように

- [x] **Step 6.3**: YouTubeショートコード対応 ✅
  - `{{< youtube VIDEO_ID >}}` → iframe埋め込み
  - レスポンシブ対応

- [x] **Step 6.4**: 記事コンテンツCSS追加 ✅
  - 見出しスタイル（masa86.com風）
  - リンクスタイル
  - コードブロックスタイル
  - 画像スタイル

---

## Phase 7: 付加機能 ✅ **完了**

### ✅ チェックリスト

- [x] **Step 7.1**: Sidebar.tsx作成 ✅
  - About表示
  - タグ一覧表示
  - レスポンシブ対応（lg以上で表示）

- [x] **Step 7.2**: SearchBox.tsx作成 ✅
  - 検索フォーム実装
  - /search?q=へ遷移

- [x] **Step 7.3**: タグページ実装 ✅
  - app/tags/[tag]/page.tsx
  - タグでフィルタリング

- [x] **Step 7.4**: 検索ページ実装 ✅
  - app/search/page.tsx
  - フルテキスト検索

- [x] **Step 7.5**: レスポンシブ対応確認 ✅
  - デスクトップ: Sidebar表示
  - タブレット/スマホ: Sidebar非表示

---

## Phase 8: SEO対応 ✅ **完了**

### ✅ チェックリスト

- [x] **Step 8.1**: サイトマップ実装 ✅
  - app/sitemap.xml/route.ts
  - 全記事、全タグ、検索ページ

- [x] **Step 8.2**: robots.txt実装 ✅
  - app/robots.txt/route.ts
  - /admin, /api は Disallow

- [x] **Step 8.3**: README.md作成 ✅
  - プロジェクト説明
  - 技術スタック
  - 実装完了状況

- [x] **Step 8.4**: 最終ビルド確認 ✅
  - `npm run build` エラーなし

- [x] **Step 8.5**: GitHubプッシュ ✅

- [x] **Step 8.6**: 本番全機能確認 ✅
  - トップページ: Sidebar表示、検索ボックス
  - 記事詳細: Sidebar表示、タグリンク
  - タグページ: フィルタリング動作
  - 検索ページ: 検索機能動作
  - 管理画面: CRUD全機能動作
  - SEO: sitemap.xml, robots.txt配信

---

## 各Phaseの成功基準 ✅ **全て達成**

### Phase 1 成功基準 ✅
✅ https://post-masa86.pages.dev/ で "Hello World" が表示される

### Phase 2 成功基準 ✅
✅ https://post-masa86.pages.dev/ で記事タイトル1件が表示される

### Phase 3 成功基準 ✅
✅ 記事詳細ページが開ける

### Phase 4 成功基準 ✅
✅ 49件全ての記事が表示される

### Phase 5 成功基準 ✅
✅ 管理画面で記事作成ができる（slug 0050生成確認）

### Phase 6 成功基準 ✅
✅ Markdown表示改善（marked導入、YouTube埋め込み、画像表示）

### Phase 7 成功基準 ✅
✅ 付加機能実装（Sidebar、検索、タグページ、レスポンシブ）

### Phase 8 成功基準 ✅
✅ SEO対応完了（sitemap.xml, robots.txt, README.md）

---

## 重要な注意事項

### 絶対に守ること

1. **wrangler.tomlは作成しない**
2. **各Stepで必ず動作確認**
3. **エラーが出たら次に進まない**
4. **Cloudflare Dashboard設定を優先**
5. **clasicjlit実装を参考にする**

### 各Step完了の判定

- ローカルビルド成功
- ローカル動作確認
- 本番デプロイ成功
- 本番動作確認

---

## 🎊 プロジェクト完了！

**実装完了日**: 2025-10-31  
**総実装時間**: 1日  
**本番URL**: https://post-masa86.pages.dev/

### 最終成果物

- ✅ **記事数**: 50件（Hugo移行49件 + 新規1件）
- ✅ **ページ数**: 12ルート（動的ページ含む）
- ✅ **コンポーネント数**: 4個
- ✅ **API Routes**: 2個
- ✅ **データベース**: D1（50件、0.18MB）
- ✅ **ビルドサイズ**: 102kB First Load JS

### 主な技術的成果

1. **wrangler.toml不使用**: Cloudflare Dashboard設定のみで安定動作
2. **段階的実装**: Phase 1→8まで着実に進行、各ステップで動作確認
3. **clasicjlit方式踏襲**: `process.env.DB`、`dynamic = 'force-dynamic'`で安定動作
4. **完全CRUD**: 管理画面で記事作成・編集・削除が動作
5. **検索・タグ機能**: フルテキスト検索、タグフィルタリング実装
6. **SEO対応**: sitemap.xml、robots.txt自動生成
7. **レスポンシブデザイン**: デスクトップ/モバイル最適化

### 学んだ教訓（blog-masa86からの改善）

- ❌ wrangler.tomlとDashboard設定の競合を回避
- ✅ Hello Worldから始める段階的アプローチが正解
- ✅ 各Phaseで必ず動作確認することで問題を早期発見
- ✅ clasicjlit実装を参考にすることで安定性向上

---

**🚀 次のステップ（オプション）**

- [ ] カスタムドメイン設定（blog.masa86.com）
- [ ] アクセス解析追加
- [ ] RSS feed実装
- [ ] OGP画像自動生成
- [ ] ページネーション実装（50件以上になったら）

