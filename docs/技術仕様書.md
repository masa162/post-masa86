# 技術仕様書 - post-masa86

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    Cloudflare Pages                      │
│                  (blog.masa86.com)                       │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│              Next.js 15 (Edge Runtime)                   │
│                                                          │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐  │
│  │   公開サイト  │  │  管理画面     │  │  API Routes   │  │
│  │   (SSR)     │  │ (Basic認証)  │  │  (D1 CRUD)    │  │
│  └─────────────┘  └──────────────┘  └───────────────┘  │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                  Cloudflare D1                           │
│                  (SQLite Database)                       │
│                                                          │
│  posts テーブル (49件の記事)                              │
└─────────────────────────────────────────────────────────┘
```

## プロジェクト構造

```
post-masa86/
├── app/
│   ├── page.tsx                    # トップページ
│   ├── [slug]/
│   │   └── page.tsx               # 記事詳細
│   ├── tags/
│   │   └── [tag]/page.tsx         # タグページ
│   ├── search/
│   │   └── page.tsx               # 検索ページ
│   ├── admin/
│   │   ├── layout.tsx             # 管理画面レイアウト（Basic認証）
│   │   ├── page.tsx               # 記事一覧
│   │   ├── new/page.tsx           # 新規作成
│   │   └── edit/[id]/page.tsx     # 編集
│   ├── api/
│   │   └── posts/
│   │       ├── route.ts           # GET/POST
│   │       └── [id]/route.ts      # GET/PUT/DELETE
│   ├── sitemap.xml/route.ts       # サイトマップ
│   ├── robots.txt/route.ts        # robots.txt
│   ├── layout.tsx                 # ルートレイアウト
│   └── globals.css                # グローバルCSS
├── components/
│   ├── Header.tsx                 # ヘッダー
│   ├── Sidebar.tsx                # サイドバー
│   ├── PostCard.tsx               # 記事カード
│   └── SearchBox.tsx              # 検索ボックス
├── lib/
│   ├── db.ts                      # D1クライアント（重要）
│   ├── types.ts                   # 型定義
│   ├── markdown.ts                # Markdown処理
│   └── auth.ts                    # Basic認証
├── types/
│   └── cloudflare.ts              # Cloudflare環境変数型定義
├── scripts/
│   └── migrate-hugo.ts            # Hugoマイグレーション
├── schema.sql                     # D1スキーマ定義
├── package.json
├── tsconfig.json
├── tailwind.config.ts
├── next.config.js                 # Next.js設定（シンプル）
└── README.md
```

## 重要な実装パターン

### 1. D1アクセス（lib/db.ts）

```typescript
import { D1Database } from '@cloudflare/workers-types'
import '../types/cloudflare'

function getD1(): D1Database | null {
  if (typeof window !== 'undefined') return null
  
  // Cloudflare Pages automatically injects DB
  if (process.env.DB) {
    return process.env.DB as D1Database
  }

  // Build-time mock
  return createMockD1()
}

function createMockD1(): D1Database {
  return {
    prepare: () => ({
      bind: () => ({
        all: async () => ({ results: [], success: true, meta: { duration: 0 } }),
        first: async () => null,
        run: async () => ({ success: true, meta: { duration: 0, last_row_id: 0, changes: 0 }, results: [] }),
      }),
    }),
  } as any
}
```

### 2. 型定義（types/cloudflare.ts）

```typescript
import { D1Database } from '@cloudflare/workers-types'

declare global {
  namespace NodeJS {
    interface ProcessEnv {
      DB?: D1Database
      BASIC_AUTH_USER?: string
      BASIC_AUTH_PASS?: string
    }
  }
}
```

### 3. サーバーコンポーネント（app/page.tsx）

```typescript
// 必須設定
export const dynamic = 'force-dynamic'
export const revalidate = 0
export const runtime = 'edge'

export default async function Home() {
  const posts = await db.getPosts(5)
  const tags = await db.getAllTags()
  
  return (
    <div className="main-container">
      {/* ... */}
    </div>
  )
}
```

### 4. API Route（app/api/posts/route.ts）

```typescript
export const dynamic = 'force-dynamic'
export const runtime = 'edge'

export async function GET(request: NextRequest) {
  try {
    const posts = await db.getPosts(20)
    return NextResponse.json({ posts })
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to fetch posts' },
      { status: 500 }
    )
  }
}
```

### 5. Basic認証（lib/auth.ts）

```typescript
export function checkBasicAuth(request: Request): boolean {
  const authHeader = request.headers.get('Authorization')
  if (!authHeader || !authHeader.startsWith('Basic ')) {
    return false
  }
  const base64Credentials = authHeader.split(' ')[1]
  const credentials = Buffer.from(base64Credentials, 'base64').toString('utf-8')
  const [username, password] = credentials.split(':')
  
  return username === 'mn' && password === '39'
}
```

## Cloudflare Pages 設定

### Build configuration（Dashboard設定）
```
Project name: post-masa86
Production branch: main
Build command: npx @cloudflare/next-on-pages
Build output directory: .vercel/output/static
Root directory: (空欄)
```

### Bindings（Dashboard設定）
```
D1 database:
  Variable name: DB
  D1 database: post-masa86-db
```

### Runtime（Dashboard設定）
```
Compatibility date: 2024-03-20
Compatibility flags: nodejs_compat
```

### Environment variables（Dashboard設定）
```
BASIC_AUTH_USER = mn
BASIC_AUTH_PASS = 39
```

## デプロイフロー

```
1. ローカル開発
   ├── npm install
   ├── D1ローカル作成（テスト用）
   └── npm run dev

2. D1本番環境準備
   ├── npx wrangler d1 create post-masa86-db
   ├── schema.sqlでテーブル作成
   └── migrate-data.sqlでデータインポート

3. Cloudflare Pages設定
   ├── GitHubリポジトリ連携
   ├── Build設定
   ├── D1バインディング（Dashboard）
   ├── nodejs_compat設定（Dashboard）
   └── 環境変数設定（Dashboard）

4. デプロイ
   └── git push origin main
       → 自動ビルド・デプロイ
```

## トラブルシューティング

### 500エラーが出る場合
1. D1バインディング（DB）が設定されているか確認
2. nodejs_compatフラグが設定されているか確認
3. wrangler.tomlが存在しないことを確認（削除）

### ビルドエラーが出る場合
1. `dynamic = 'force-dynamic'`が全ルートにあるか確認
2. `runtime = 'edge'`が設定されているか確認
3. D1へのアクセスに`process.env.DB`を使用しているか確認

### D1接続エラーが出る場合
1. database_idが正しいか確認
2. D1にデータが入っているか確認（wrangler d1 execute）
3. バインディングのVariable nameが`DB`（大文字）か確認

## パフォーマンス最適化

### エッジキャッシング
- 静的アセットはCDNでキャッシュ
- 動的ページもEdgeで高速レンダリング

### データベースクエリ
- インデックスを適切に設定
- LIMIT句で取得件数を制限
- 不要なJOINを避ける

---

**最終更新**: 2025-10-30  
**レビュアー**: masa162

